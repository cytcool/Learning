# 计算机网络

- 计算机网络是通信技术与计算机技术紧密结合的产物
- 定义：计算机网络就是互连的、自治的计算机集合
- 自治-无主从关系
- 互连-互联互通

##### 当主机之间的距离远、数量大如何保证互连

- 通过交换网络互连主机
- 交换网络中最主要的部分：交换节点
- 交换节点：路由器或交换机

## 什么是Internet？

### 组成细节角度
- 全球最大的互联网络 ISP(Internet Service Provider）
- 数以百万计的互连的计算设备集合
- 计算设备通过通信链路和分组交换来进行连接
- 通信链路：光纤、铜缆、无线电、卫星等
- 分组交换：转发分组(数据包) 
路由器和交换机

### 服务角度

- 为网络应用提供通信服务的通信基础设施：Web,VoIP,email等
- 为网络应用提供应用编程接口(API)

## 什么是网络协议

- 协议是计算机网络有序运行的重要保证
- 硬件是计算机网络的基础
- 计算机网络中的数据交换必须遵守事先约定好的规则
- 如同交通系统中的交通规则

### 网络协议

- ==网络协议==，简称为==协议==，是为进行网络中的数据交换而建立的规则、标准或约定
- ==协议==规定了通信实体之间所交换的消息的==格式==、==意义==、==顺序==以及针对收到信息或发生的事件所采取的“==动作==”(actions)
- 不同的协议功能也不相同
- 协议规范了网络中所有信息发送和接收过程

### 协议的三要素

- 语法：数据与控制信息的结构或格式
- 语义：需要发出何种控制信息 完成何种动作以及做出何种响应 进行差错控制
- 时序：事件顺序和速度匹配

## 计算机网络结构

### 网络边缘

- 主机（端系统）：位于“网络边缘”，运行网络应用程序
- 网络应用
- 客户/服务器(client/server)应用模型：客户发送请求，接收服务器相应
- 对等(peer-peer,P2P)应用模型：无专用服务器，通信在对等实体之间直接进行

### 接入网络，物理介质：
- 有线或无线通信链路
- 数字用户线路：利用已有的电话线连接中心局的DSLAM
- 电缆网络
- 机构(企业)接入网络
- 无线接入网络：通过共享的网线接入网络连接端系统与路由器

### 网络核心（核心网络）：
- 互联的路由器（或分组转发设备）
- 网络之网络
- 网络核心的关键功能：==路由==  + ==转发==
- 路由：确定分组从源到目的传输路径
- 转发：将分组从路由器的输入端口交换至正确的输出端口
- 如何实现实现数据从源主机通过网络核心送达目的主机：==数据交换==

#### 数据交换

##### 类型

- 电路交换
- 报文交换
- 分组交换

##### 电路交换

- 最典型电路交换网络：电话网络
- 电路交换的三个阶段：建立连接（呼叫/电路建立）、通信、释放连接（拆除电路）
- 最显著的特点：独占资源
- 电路交换网络中，每条电路并不是独占其经过的物理链路的
- 电路交换网络链路共享，是通==过多路复用技术==进行共享中继线

##### 报文交换

- ==报文==：源（应用）发送信息整体 比如：一个文件

##### 分组交换

- ==分组==：报文分拆出来的一系列相对较小的数据包
- 分组交换需要报文的==拆分==与==重组==
- 产生==额外开销==
- 分组交换采用==统计多路复用==

##### ==报文交换==与==分组交换==均采用==存储-转发==交换方式

##### 区别：

- 报文交换以==完整报文==进行“存储-转发”
- 分组交换以较小的==分组==进行“存储-转发”

### Internet结构：网络之网络

- 端系统通过==接入ISP==连接到Internet
- 接入ISP必须进一步互连：这样任意两个主机才可以互相发送分组
- 构成复杂的网络互连的网络


### 多路复用

- 链路/网络资源（如带宽）划分为“资源片”
- 将资源片分配给各路“呼叫”
- 每路呼叫独占分配到的资源片进行通信
- 资源片可能“闲置”（无共享）

#### 典型多路复用方法：
- 频分多路复用 FDM
- 时分多路复用 TDM
- 波分多路复用 WDM
- 码分多路复用 CDM

## 计算机网络性能

### 速率

#### ==速率==即==数据率==或称==数据传输速率==或==比特率==

- 单位时间（秒）传输信息（比特）量
- 计算机网络中最重要的一个性能指标
- 单位：b/s（或bps）、kb/s、Mb/s、Gb/s
- k=10^3、 M=10^6、 G=10^9

#### 速率往往是指==额定速率==或==标称速率==

### 带宽

- ”带宽“原本指信号具有的宽度，即最高频率与最低频率之差，单位是赫兹（HZ）
- 网络的“带宽”通常是数字信道所能传送的“最高数据率”，单位：b/s（bps）

### 延迟/时延

- 结点处理延迟：差错检测，确定输出链路
- 排队延迟：等待输出链路可用，取决于路由器拥塞程度
- 传输延迟：取决于分组长度和链路带宽
- 传播延迟：取决于物理链路长度和信号传播速度

### 时延带宽积

- 时延带宽积=传播时延X带宽
- 链路的时延带宽积又称为以比特为单位的链路长度

### 分组丢失（丢包）

- 队列缓存容量有限
- 分组到达已满队列将被丢弃（即丢包）
- 丢弃分组可能由前序节点或源重发（也可能不重发）

### 吞吐量/率

- 吞吐量：表示在发送端与接收端之间传送数据速率
- 即时吞吐量：给定时刻的速率
- 平均吞吐量：一段时间的平均速率

## 计算机网络体系结构

- 网络体系结构是从==功能上==描述计算机网络结构
- 计算机网络体系结构简称网络体系结构，是==分层结构==
- 每层遵循某==个网络协议==完成本层功能
- ==计算机网络体系结构==是计算机网络的各层及其协议的结合
- 体系结构是一个计算机网络的功能层次及其关系的==定义==
- 体系结构是==抽象的==

#### 为什么采用分层结构？

- 结构清晰，有利于识别复杂系统的部件及其关系
- 模块化的分层易于系统更新、维护
- 有利于标准化
- 分层太多会导致效率降低

### 分层网络体系结构基本概念

- ==实体==：表示任何可发送或接受信息的硬件或软件进程
- 协议是控制==两个对等实体==进行通信的规则的结合，协议是“==水平的==”
- 任一层实体需要使用==下层==服务，遵循本层协议，实现本层功能，向==上层==提供服务，服务是“==垂直的==”，相邻的两层之间存在==服务与被服务==的关系
- 下层协议的实现对上层的服务用户是==透明的==，即上层不知道下层协议是如何实现的
- 同系统的相邻层实体间通过==接口==进行交互，通过==服务访问点SAP==，交换==原语==，指定请求的特定服务

## OSI参考模型

- 应用层
- 表示层
- 会话层
- 传输层
- 网络层
- 数据链路层
- 物理层

### 端-端层

- 包括：应用层、表示层、会话层、传输层

### 非端-端层

- 包括：网络层、数据链路层、物理层

#### 物理层功能

- 接口特性：机械特性、电气特性、功能特性、规程特性
- 比特编码
- 数据率
- 比特同步：时钟同步
- 传输模式：单工、半双工、全双工

#### 数据链路层功能

- 负责==结点-结点==数据传输
- 组帧：数据加头加尾
- 物理寻址：在帧头中增加发送端和/或接收端的物理地址标识数据帧的发送端和/或接收端
- 流量控制：避免淹没接收端
- 差错控制：检测并重传损坏或丢失帧，并避免重复帧
- 访问（接入）控制：在任一给定时刻决定哪个设备拥有链路（物理介质）控制使用权

#### 网络层功能

- 负责源主机到目的主机数据分组交付
- 逻辑寻址：全局唯一逻辑地址，确保数据分组被送达目的主机，如IP地址
- 路由：路由器互连网络，并路由分组至最终目的主机，路径选择
- 分组转发

#### 传输层功能

- 负责源-目的（端-端）（进程间）完整报文传输
- 报文的分段与重组
- SAP寻址：确保将完整报文提交给正确进程，如端口号
- 连接控制
- 流量控制
- 差错控制

#### 会话层功能

- 对话控制：建立、维护
- 同步：在数据流中插入“同步点”

#### 表示层功能

- 处理两个系统间交换信息的语法与语义问题
- 数据表示转化：转换为主机独立的编码
- 加密/解密
- 压缩/解压缩

#### 应用层功能

- 支持用户通过用户代理（如浏览器）或网络接口使用网络（服务）
- 典型应用服务：文件传输（FTP）、电子邮件（SMTP）、Web（HTTP）

### TCP/IP参考模型

- 应用层：HTTP SMTP DNS RTP
- 运输层：TCP UDP
- 网际层：IP
- 网络接口层：网络接口

### 5层参考模型

#### 综合OSI和TCP/IP的优点

- 应用层：支持各种网络应用
- 传输层：进程-进程的数据传输
- 网络层：源主机到目的主机的数据分组路由与转发
- 数据链路层：相邻网络元素的数据传输
- 物理层：比特传输

## 网络应用

### 网络应用的体系结构

- 客户机/服务器结构
- 点对点结构（P2P)
- 混合结构

#### 客户机/服务器结构

- 例子：Web访问

##### 服务器

- 7*24小时提供服务
- 永久性访问地址/域名
- 利用大量服务器实现可扩展性

##### 客户机

- 与服务器通信，使用服务器提供的服务
- 间歇性接入网络
- 可能使用动态IP地址
- 不会与其他客户机直接通信


#### P2P结构

- 没有永远在线的服务器
- 任意端系统/节点之间可以直接通讯
- 节点间歇性接入网络
- 节点可能改变IP地址
- ==优点：高度可伸缩==
- ==缺点：难于管理==
- 例子：文件共享、文件下载

#### 混合结构

##### Napster

- 文件传输使用P2P结构
- 文件的搜索采用C/S结构——集中式（每个节点向中央服务器登记自己的内容，每个节点向中央服务器提交查询请求，查找感兴趣的内容）

### 网络应用进程通信

- 网络应用的基础：进程间通信

#### 进程

- 主机上运行的程序
- 客户机进程：发起通信的进程
- 服务器进程：等待通信请求的进程

#### 同一主机上运行的进程之间如何通信

- 进程间通信机制
- 操作系统提供

#### 不同主机上运行的进程间如何通信

- 消息交换

#### 套接字：Socket

- 进程间通信利用socket发送/接收消息实现
- 类似于寄信：发送方将消息送到门外邮箱，发送方依赖传输基础设施将消息传到接收方所在主机，并送到接收方的门外，接收方从门外获取消息
- 传输基础设施向进程提供API（传输协议的选择、参数的设置）

#### 如何寻址进程？

- 不同主机上的进程间通信，那么每个进程必须拥有==标识符==
- 如何寻址主机？——IP地址，主机有了IP地址后不足以定位进程，因为同一主机上可能同时又多个进程需要通信
- 端口号：为主机上每个需要通信的进程分配一个端口号
- 进程的标识符：IP地址+端口号

### 应用层协议

- 网络应用需遵循应用层协议
- 公开协议：由RFC定义、允许互操作
- 私有协议：多数P2P文件共享应用

#### 内容

- 消息的类型：请求消息、响应消息
- 消息的语法/格式：消息中有哪些字段和每个字段如何描述
- 字段的语义：字段中消息的含义
- 规则：进程何时发送/相应消息

### 网络应用的需求与传输层服务

- 数据丢失/可靠性
- 时间/延迟
- 带宽

### Web应用

- 网页包含多个对象
- 对象的寻址：URL（统一资源定位器）

### HTTP协议概述

- 超文本传输协议
- C/S结构：客户（请求、接收、展示Web对象）服务器（响应客户的请求，发送对象）
- 使用TCP传输服务（服务器在80端口等待客户的请求、浏览器发起到服务器的TCP连接，创建套接字Socket、服务器接收来自浏览器的TCP连接、浏览器与Web服务器交换HTTP消息、关闭TCP连接）
- 无状态：服务器不维护任何有关客户端过去所发请求的信息

### HTTP连接

- 非持久性连接：每个TCP连接最多允许传输==一个==对象
- 持久性连接：每个TCP连接允许传输==多个==对象

### Cookie技术

- 某些网站为了辨别用户身份，进行会话跟踪而存储在用户本地终端上的数据（通常经过加密）

#### 组件

- HTTP响应消息的cookie头部行
- HTTP请求消息的cookie头部行
- 保存在客户端主机上的cookie文件，由浏览器管理
- Web服务器端的后台数据库

#### 作用

- 身份认证
- 购物车
- 推荐
- Web-email

### Web缓存/代理服务器技术

#### 功能

- 在不访问服务器的前提下满足客户端的HTTP请求

#### 为什么要发明这种技术

- 缩短客户请求的响应时间
- 减少机构/组织的流量
- 在大范围内实现有效的内容分发

### Email应用

#### 组成构建

- 邮件客户端
- 邮件服务端
- SMTP协议

##### 邮件客户端

- 读、写Email消息
- 与服务器交互，收、发Email消息
- Outlook、Foxmail、Thunderbird
- Web客户端

##### 邮件服务器

- 邮箱：存储发给该用户的Email
- 消息队列：存储等待发送的Email

##### SMTP协议

- 邮件服务器之间传递消息所使用的协议
- 客户端：发送消息的服务器
- 服务器：接收消息的服务器
- 使用TCP进行email消息的可靠传输
- 端口25
- 传输过程的三个阶段：握手、消息的传输、关闭
- 命令/响应交互模式：命令（ASCII文本）、响应（状态代码和语句）
- Email消息只能包含7位ASCII吗
- 使用持久性连接
- 要求消息必须由7位ASCII码构成
- SMTP服务器利用CRLF.CRLF确定消息的结束

#### Email消息格式

- 头部行(header)：To、From、Subject
- 消息体(body)：消息本身，只能是ASCII字符

#### 邮件访问协议

- 从服务器获取邮件

##### 类别

- POP：“下载并删除”模式、“下载并保持”模式，POP3是无状态的
- IMAP：所有消息统一保存在服务器里，允许用户利用文件夹组织消息，支持跨会话的用户状态
- HTTP

### 域名解析系统DNS：Domain Name System

- Internet上主机/路由器的识别问题：IP地址、域名
- 多层命名服务器构成的分布式数据库
- 应用层协议：完成名字的解析

#### DNS服务

- 域名向IP地址的翻译
- 主机别名
- 邮件服务器别名
- 负载均衡：Web服务器

#### DNS根域名服务器

- 本地域名解析服务器无法解析域名时，访问根域名服务器
- 根域名服务器：如果不知道映射，访问权威域名服务器，获得映射，向本地域名服务器返回映射

### 纯P2P架构

- 没有服务器
- 任意端系统之间直接通信
- 节点阶段性接入Internet
- 节点可能更换IP地址

## Socket编程

### Socket抽象

- 类似于文件的抽象
- 当应用进程创建套接字时，操作系统分配一个数据结构存储该套接字相关信息
- 返回套接字描述符

### Socket API函数

#### WSAStartup

- 使用Socket的应用程序在使用Socket之前必须首先调用WSAStartup函数
- 两个参数：第一个参数指明程序请求使用的WinSock版本，其中高位字节指明副版本、低位字节指明主版本，第二个参数返回实际的WinSock的版本信息

#### WSACleanup

- 应用程序在完成对请求的Socket库的使用，最后要调用WSACleanup函数
- 接触与Socket库的绑定
- 释放Socket库所占用的系统资源

#### socket

- sd = socket(protofamily,type,proto);
- 作用：创建套接字
- 操作系统返回套接字描述符（sd）
- 第一个参数（协议族）：protofamily = PF_INET(TCP/IP)
- 第二个参数（套接字类型）：type = SOCK_STREAM,SOCK_DGRAM,SOCK_RAW(TCP/IP)
- 第三个参数(协议号):0为默认

#### Socket面向TCP/IP的服务类型

- SOCK_STREAM对应的传输层的TCP
- SOCK_DGRAM对应的传输层的UDP
- SOCK_RAW对应的网络层IP/ICMP/IGMP
- TCP：可靠、面向连接、字节流传输、点对点
- UDP：不可靠、无连接、数据报传输

#### Closesocket

- int closesocket(SOCKET ad);
- 关闭一个描述符为sd的套接字
- 如果多个进程共享一个套接字，调用closesocket将套接字引用计数减1，减至0才关闭
- 一个进程中的多线程对一个套接字的使用无计数，如果进程中的一个线程调用closesocket将一个套接字关闭，该进程中的其他线程也将不能访问该套接字
- 返回值：0成功，SOCKET_ERROR失败

#### bind

- int bind(sd,localaddr,addrlen);
- 绑定套接字的本地端点地址：IP地址+端口号
- 参数：套接字描述符（sd），端点地址（localadd人）
- 客户程序一般不必调用bind函数

#### listen

- int listen(sd,queuesize);
- 置服务器端的流套接字处于监听状态：仅服务器端调用、仅用于面向连接的流套接字
- 设置连接请求队列大小
- 返回值：0成功、SOCKET_ERROR失败

#### connect

- connect(sd,saddr,saddrlen);
- 客户程序调用connect函数来使客户套接字(sd)与特定计算机的特定端口(saddr)的套接字(服务)进行连接
- 仅用于客户端
- 可用于TCP客户端也可以用于UDP客户端

### 解析服务器IP地址

- 客户端可能使用域名或IP地址标识服务器
- IP协议需要使用32位二进制IP地址
- 需要将域名或IP地址转换为32位IP地址

### 解析服务器端口号

- 客户端还可能使用服务名（如HTTP）标识服务器端口
- 需要将服务名转换为熟知端口号

### 解析协议号

- 客户端可能使用协议名（如TCP）指定协议
- 需要将协议名转换为协议号

### TCP客户端软件流程

- 1、确定服务器IP地址与端口号
- 2、创建套接字
- 3、分配本地端点地址（IP地址+端口号）
- **4、连接服务器（套接字）**
- 5、遵循应用层协议进行通信
- 6、关闭/释放连接

### UDP客户端软件流程

- 1、确定服务器IP地址与端口号
- 2、创建套接字
- 3、分配本地端点地址（IP地址+端口号）
- **4、指定服务器端点地址，构造UDP数据报**
- 5、遵循应用层协议进行通信
- 6、关闭/释放连接

## 服务器软件设计

### 循环无连接服务器

- 1、创建套接字
- 2、绑定端点地址（INADDR_ANY+端口号）
- 3、反复接收来自客户端的请求
- 4、遵循应用层协议，构造响应报文，发送给客户

#### 数据发送

- 服务器端不能使用connect()函数
- 无连接服务器使用sendto()函数发送数据报

#### 获取客户端点地址

- 调用recvfrom()函数接收数据时，自动提取

### 循环面向连接服务器基本流程

- 1、创建套接字，并绑定熟知端口号
- 2、设置套接字为被动监听模式，准备用于服务器
- 3、调用accept()函数接收下一个连接请求（通过主套接字），创建新套接字用于与该客户建立连接
- 4、遵循应用层协议，反复接收客户请求，构造并发送响应
- 5、完成为特定客户服务后，关闭与该客户之间的连接，返回步骤3

### 并发无连接服务器基本流程

- 主线程1：创建套接字，并绑定熟知端口号
- 主线程2：反复调用recvfrom()函数，接收下一个客户请求，并创建新线程处理该客户响应
- 子线程1：接收一个特定请求
- 子线程2：依据应用层协议构造响应报文，并调用sendto()发送
- 子线程3：退出（一个子线程处理一个请求后即终止）

### 并发面向连接服务器基本流程

- 主线程1：创建套接字，并绑定熟知端口号
- 主线程2：设置套接字为被动监听模式，准备用于服务器
- 主线程3：反复调用accept()函数接收下一个连接请求（通过主套接字），并创建一个新的子线程处理该客户响应
- 子线程1：接收一个客户的服务请求
- 子线程2：遵循应用层协议与特定客户进行交互
- 关闭/释放连接并退出

